<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Content Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .section-card {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            margin-bottom: 1rem;
        }
        /* Style for the image generation modal overlay */
        .ai-modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            transition: opacity 300ms ease-in-out;
            z-index: 1000;
        }
        .ai-modal-content {
            z-index: 1001;
        }
        .preview-container {
            height: 120px;
            width: 192px; /* Approx 3:2 ratio */
        }
        /* Class for highlighting the selected project */
        .project-selected {
            border: 2px solid #4f46e5; /* Indigo-600 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Sticky Save/Copy bar */
        .sticky-actions {
            position: sticky;
            top: 0;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-4xl font-black text-indigo-700 mb-2">Portfolio Content Editor</h1>
        <p class="text-gray-600 mb-8">Edit your project data below. When done, copy the generated code and paste it into the **`projects_data.js`** file.</p>

        <div class="p-4 mb-8 border border-yellow-300 bg-yellow-50 rounded-lg">
            <label for="geminiApiKey" class="block text-sm font-bold text-gray-700 mb-2">Gemini API Key (Required for AI features)</label>
            <input type="password" id="geminiApiKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Enter your Gemini API Key here" oninput="localStorage.setItem('geminiApiKey', this.value)">
            <p class="text-xs text-gray-600 mt-1">This key is only stored locally in your browser for the duration of this session.</p>
        </div>
        
        <div class="sticky-actions bg-white p-4 mb-6 border-b border-gray-200 shadow-lg -mx-10 px-10">
            <div class="flex flex-col md:flex-row md:items-center justify-between space-y-3 md:space-y-0 md:space-x-4">
                
                <div class="flex items-center space-x-2 flex-grow">
                    <label for="quick-select-project" class="text-sm font-medium text-gray-700">Jump to Project:</label>
                    <select id="quick-select-project" onchange="selectProject(this.value)" class="py-2 px-3 border border-gray-300 rounded-md shadow-sm w-full md:w-auto">
                        <option value="">-- Select Project --</option>
                    </select>
                </div>
                
                <div class="flex space-x-3 flex-shrink-0">
                    <button onclick="createNewProject()" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                        âž• Add New Project
                    </button>
                    <button onclick="handleSaveAndCopy()" class="inline-flex items-center justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        ðŸ’¾ Save & Copy Code
                    </button>
                    <button onclick="saveChangesToLocalStorage()" class="hidden md:inline-flex items-center justify-center px-4 py-2 border border-indigo-600 shadow-sm text-sm font-medium rounded-md text-indigo-600 bg-white hover:bg-indigo-50 focus:outline-none">
                        ðŸ’¾ Save to Browser
                    </button>
                </div>
            </div>
        </div>


        <div id="project-list" class="space-y-2">
            </div>

        <div id="editing-area" class="mt-10 p-6 border border-gray-200 rounded-lg bg-white shadow-inner hidden">
            <h2 class="text-2xl font-bold mb-4">Edit Project: <span id="edit-title" class="text-indigo-600"></span></h2>
            
            <form id="project-form" class="space-y-6">
                
                <h3 class="text-xl font-semibold border-b pb-2 mb-4">A. General Project Info</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ID (Read-Only)</label>
                        <input type="text" id="id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 p-2" readonly>
                    </div>
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700">Project Title</label>
                        <input type="text" id="title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Category (Select or Type New)</label>
                        <select id="category-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></select>
                        <input type="text" id="category-custom" placeholder="Or enter new category..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border hidden">
                    </div>
                    
                    <div>
                        <label for="year" class="block tock text-sm font-medium text-gray-700">Year</label>
                        <input type="number" id="year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    
                    <div>
                        <label for="accentColor-select" class="block text-sm font-medium text-gray-700 mb-2">Accent Color (Tailwind Class)</label>
                        <div class="flex items-center space-x-3">
                            <select id="accentColor-select" class="block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="updateAccentColorPreview()">
                                </select>
                            <div id="accentColor-preview" class="h-8 w-8 rounded-md border-2 border-gray-300 flex-shrink-0"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="heroImage" class="block text-sm font-medium text-gray-700">Hero Image URL</label>
                    <div class="flex space-x-2 mt-1">
                        <input type="url" id="heroImage" class="block w-full rounded-md border-gray-300 shadow-sm p-2 border" oninput="updateImagePreview('heroImage', this.value)">
                        <button type="button" onclick="openImagePrompt('heroImage')" class="flex-shrink-0 px-4 py-2 bg-pink-600 text-white text-sm font-medium rounded-md hover:bg-pink-700 disabled:bg-gray-400">
                            ðŸŽ¨ Generate (AI)
                        </button>
                    </div>
                    <div id="heroImage-preview-container" class="mt-2">
                        <div id="heroImage-preview" class="preview-container border border-gray-300 rounded-md bg-gray-200 overflow-hidden"></div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3 p-3 border border-red-300 bg-red-50 rounded-md">
                    <input type="checkbox" id="isHidden" class="rounded text-red-600 focus:ring-red-500">
                    <label for="isHidden" class="text-base font-medium text-red-700">Hide Project (Draft Mode)</label>
                    <p class="text-xs text-red-600">(If checked, this project will NOT appear on the live site.)</p>
                </div>
                
                <h3 class="text-xl font-semibold border-b pb-2 mb-4 pt-4">B. Modal Intro & Details</h3>

                <div>
                    <label for="brief" class="block text-sm font-medium text-gray-700">Brief (Modal Intro Summary)</label>
                    <div class="flex space-x-2 mt-1">
                        <textarea id="brief" rows="3" class="block w-full rounded-md border-gray-300 shadow-sm p-2 border"></textarea>
                        <button type="button" onclick="generateBriefWithGemini()" id="generate-brief-btn" class="flex-shrink-0 px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700 self-start disabled:bg-gray-400">
                            âœ¨ Generate Brief (AI)
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border p-4 rounded-md bg-gray-50">
                    <div class="flex flex-col">
                        <div class="flex items-center space-x-2 mb-1">
                            <input type="checkbox" id="enableClient" class="rounded text-indigo-600 focus:ring-indigo-500">
                            <label for="enableClient" class="text-sm font-medium text-gray-700">Client</label>
                        </div>
                        <input type="text" id="client" class="block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div class="flex flex-col">
                        <div class="flex items-center space-x-2 mb-1">
                            <input type="checkbox" id="enableRole" class="rounded text-indigo-600 focus:ring-indigo-500">
                            <label for="enableRole" class="text-sm font-medium text-gray-700">Role</label>
                        </div>
                        <input type="text" id="role" class="block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div class="flex flex-col">
                        <div class="flex items-center space-x-2 mb-1">
                            <input type="checkbox" id="enableDuration" class="rounded text-indigo-600 focus:ring-indigo-500">
                            <label for="enableDuration" class="text-sm font-medium text-gray-700">Duration</label>
                        </div>
                        <input type="text" id="duration" class="block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold border-b pb-2 mb-4 pt-4">C. Case Study Sections</h3>
                <div id="sections-container" class="space-y-4">
                    </div>
                
                <button type="button" onclick="addSectionField()" class="mt-2 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                    âž• Add New Section
                </button>
                
            </form>
            
            <div class="flex space-x-4 mt-6">
                <button onclick="handleSaveAndCopy()" class="inline-flex items-center justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex-grow">
                    ðŸ’¾ Save & Copy Code
                </button>
                <button onclick="saveChangesToLocalStorage()" class="inline-flex items-center justify-center px-4 py-2 border border-indigo-600 shadow-sm text-sm font-medium rounded-md text-indigo-600 bg-white hover:bg-indigo-50 focus:outline-none flex-grow">
                    ðŸ’¾ Save to Browser
                </button>
            </div>
        </div>

        <div class="mt-10 p-6 border-t pt-8">
            <h2 class="text-3xl font-bold mb-4">Generated Project Data (Copy/Paste OVERWHOLE FILE)</h2>
            <p class="text-sm text-red-600 mb-4">ðŸš¨ **CRITICAL STEP:** Copy ALL text below and **REPLACE THE ENTIRE CONTENTS** of your **`projects_data.js`** file with it.</p>
            <textarea id="js-output" rows="20" class="w-full rounded-md border-gray-300 shadow-sm p-3 border font-mono text-xs bg-gray-800 text-green-300" readonly></textarea>
        </div>
    </div>

    <div id="image-prompt-modal" class="fixed inset-0 hidden ai-modal-overlay flex items-center justify-center p-4">
        <div class="ai-modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-4">AI Image Generator (Nano Banana)</h3>
            <p class="text-sm text-gray-600 mb-4">Describe the image you want to generate. Be specific about style, color, and content (e.g., 'Minimalist dark-mode SaaS dashboard chart showing growth').</p>
            <textarea id="image-prompt-input" rows="3" class="w-full rounded-md border-gray-300 shadow-sm p-2 border mb-4"></textarea>
            
            <div id="image-generation-status" class="text-sm text-yellow-700 mb-4 hidden">Generating image... This may take up to 30 seconds.</div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeImagePrompt()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" onclick="startImageGeneration()" id="start-image-generation-btn" class="px-4 py-2 bg-pink-600 text-white rounded-md hover:bg-pink-700 disabled:bg-gray-400">
                    Generate Image
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL CONSTANTS ---
        const IMAGE_GENERATION_MODEL = 'imagen-4.0-generate-001';
        let currentImageFieldId = null; 
        
        // FIX: The project array in the original admin.html was an initial default. 
        // We'll load the real data from projects_data.js directly if it's available, otherwise use a safe default.
        // NOTE: Since the admin portal is for editing, we load the *attached* projects_data.js content.
        let currentProjects = [
    // Project 1 (Initial Data for Admin Panel)
    {
        id: 'project-1', title: 'FlowState App: Meditation & Sleep', category: 'UI/UX Mobile App', year: '2024',
        heroImage: 'https://placehold.co/800x600/1e293b/f1f5f9?text=FlowState+Mobile+Hero', accentColor: 'bg-indigo-600', 
        isHidden: false,
        caseStudy: {
            client: 'FlowState Wellness', role: 'Lead UX/UI Designer', duration: '4 Months',
            brief: 'A complete redesign of a mindfulness application focused on reducing friction in the daily tracking process and enhancing the visual language for a calm user experience.',
            sections: [
                { id: 'problem', title: '01. The Problem & Goal', content: 'The existing app suffered from high churn rates (35% after the first week) primarily due to an overwhelming onboarding process and a dated visual style that lacked emotional connection. The core goal was to simplify the daily tracking routine to increase retention and daily active usage (DAU) by 20%.', mediaItems: [{ url: 'https://placehold.co/1200x600/334155/e2e8f0?text=UX+Wireframing+and+User+Flows', isVideo: false }] },
            ],
        }
    },
    // The rest of your default array is removed for conciseness, 
    // but in a real-world scenario, you'd want to load the *actual* data from projects_data.js here
];

// CRITICAL FIX: Load ALL_PROJECTS from the attached projects_data.js as the starting state
if (typeof ALL_PROJECTS !== 'undefined') {
    currentProjects = ALL_PROJECTS;
}


        const TAILWIND_COLORS_MAP = [
            { class: 'bg-indigo-600', hex: '#4f46e5', name: 'Indigo' },
            { class: 'bg-blue-600', hex: '#2563eb', name: 'Blue' },
            { class: 'bg-green-600', hex: '#16a34a', name: 'Green' },
            { class: 'bg-emerald-700', hex: '#059669', name: 'Emerald' },
            { class: 'bg-yellow-600', hex: '#ca8a04', name: 'Yellow' },
            { class: 'bg-orange-600', hex: '#ea580c', name: 'Orange' },
            { class: 'bg-red-600', hex: '#dc2626', name: 'Red' },
            { class: 'bg-pink-600', hex: '#db2777', name: 'Pink' },
            { class: 'bg-purple-600', hex: '#9333ea', name: 'Purple' },
            { class: 'bg-gray-700', hex: '#374151', name: 'Gray' }
        ];

        let UNIQUE_CATEGORIES = []; 
        let selectedProject = null;

        // --- CORE UI/STATE FUNCTIONS ---
        
        // --- UTILITY FUNCTIONS ---
        function collectUniqueCategories() {
            const categories = new Set();
            currentProjects.forEach(p => categories.add(p.category));
            UNIQUE_CATEGORIES = Array.from(categories).sort();
        }

        function updateAccentColorPreview() {
            const select = document.getElementById('accentColor-select');
            const preview = document.getElementById('accentColor-preview');
            const colorClass = select.value;
            
            const allClasses = TAILWIND_COLORS_MAP.map(c => c.class).join(' ');
            
            // Remove all known color classes before adding the new one
            preview.classList.remove(...allClasses.split(' ').filter(cls => cls));
            
            preview.classList.add(colorClass);
        }
        
        // Preview function for the single Hero Image (No video option needed)
        function updateImagePreview(fieldId, url) {
            const previewId = `${fieldId}-preview`;
            const previewDiv = document.getElementById(previewId);
            
            if (url && url.trim()) {
                previewDiv.innerHTML = `<img src="${url.trim()}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/192x120/cc0000/ffffff?text=Load+Error';" />`;
            } else {
                previewDiv.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-500 text-xs">No Media URL</div>`;
            }
        }
        
        // Preview function for dynamic section media items (handles video checkbox)
        function updateSectionMediaPreview(urlInputId, isVideoId) {
            // FIX: This function now reads the *current* state of the input fields, not the saved state
            const url = document.getElementById(urlInputId)?.value || '';
            const previewId = `${urlInputId}-preview`;
            const previewDiv = document.getElementById(previewId);
            const isVideoChecked = document.getElementById(isVideoId)?.checked || false;

            if (!previewDiv) return;

            if (url && url.trim()) {
                if (isVideoChecked) {
                    previewDiv.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-500 text-xs bg-gray-300">Video URL entered (Preview not supported)</div>`;
                } else {
                    previewDiv.innerHTML = `<img src="${url.trim()}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/192x120/cc0000/ffffff?text=Load+Error';" />`;
                }
            } else {
                previewDiv.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-500 text-xs">No Media URL</div>`;
            }
        }
        
        function renderColorPicker(selectedColor) {
            const select = document.getElementById('accentColor-select');
            select.innerHTML = '';

            TAILWIND_COLORS_MAP.forEach(color => {
                const option = document.createElement('option');
                option.value = color.class;
                option.textContent = `${color.name} (${color.class})`;
                select.appendChild(option);
            });
            
            select.value = selectedColor;
        }

        function initializeApp() {
            const storedData = localStorage.getItem('portfolioProjects');
            // FIX: Prioritize localStorage only if it exists, otherwise use the data from projects_data.js
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    
                    // CRITICAL FIX: Ensure the project array uses the latest structure
                    currentProjects = parsedData.map(p => ({
                        id: p.id,
                        title: p.title,
                        category: p.category,
                        year: p.year,
                        heroImage: p.heroImage,
                        accentColor: p.accentColor || TAILWIND_COLORS_MAP[0].class,
                        isHidden: p.isHidden !== undefined ? p.isHidden : false,
                        caseStudy: {
                            client: p.caseStudy.client || '', 
                            role: p.caseStudy.role || '', 
                            duration: p.caseStudy.duration || '',
                            brief: p.caseStudy.brief || '',
                            sections: p.caseStudy.sections.map(s => {
                                let mediaItems;
                                
                                if (s.mediaItems && Array.isArray(s.mediaItems)) {
                                    mediaItems = s.mediaItems.map(item => ({
                                        url: item.url || '',
                                        isVideo: item.isVideo !== undefined ? item.isVideo : false
                                    }));
                                } else {
                                    // Fallback for older/migrated structure
                                    mediaItems = [];
                                }

                                return {
                                    id: s.id,
                                    title: s.title,
                                    content: s.content || '',
                                    mediaItems: mediaItems,
                                };
                            }),
                        },
                    }));
                } catch (e) {
                    console.error("Failed to parse stored projects data, using default/projects_data.js.", e);
                }
            }
            
            collectUniqueCategories(); 
            renderProjectList();
            updateJSOutput();
            
            const storedApiKey = localStorage.getItem('geminiApiKey');
            if (storedApiKey) {
                document.getElementById('geminiApiKey').value = storedApiKey;
            }

            // OPTIMIZATION: Select the first project automatically if none is selected
            if (currentProjects.length > 0 && !selectedProject) {
                selectProject(currentProjects[0].id);
            }
        }
        
        // --- GEMINI API HELPERS ---
        
        async function runGeminiRequest(prompt, maxRetries = 5) {
            const apiKey = document.getElementById('geminiApiKey').value;
            if (!apiKey) {
                throw new Error("API Key is missing. Please enter your Gemini API Key.");
            }
            // Key is already saved on input, no need to save again here

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "You are a professional UX/UI design copywriter. Your response must be a single, concise paragraph (under 30 words) used as a project summary/brief." }]
                }
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded, retrying in ${Math.round(delay / 1000)}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API request failed: ${response.status} - ${errorData.error?.message || response.statusText}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) return text;
                    throw new Error("Received empty or invalid response from API.");

                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                }
            }
        }
        
        async function generateBriefWithGemini() {
             const btn = document.getElementById('generate-brief-btn');
            const briefArea = document.getElementById('brief');
            const originalText = btn.textContent;
            
            if (!selectedProject) return alert("Please select a project to edit first.");
            // FIX: Validate API key before disabling the button
            if (!document.getElementById('geminiApiKey').value) {
                return alert("Please enter your Gemini API Key first.");
            }

            btn.disabled = true;
            btn.textContent = 'Generating...';

            const projectTitle = document.getElementById('title').value;
            const projectCategory = document.getElementById('category-select').value !== '--- Custom/New Category ---' 
                ? document.getElementById('category-select').value 
                : document.getElementById('category-custom').value;
            const projectYear = document.getElementById('year').value;

            const prompt = `Write a compelling, single-sentence project brief for a ${projectCategory} project titled "${projectTitle}" from ${projectYear}. The brief should summarize the goal and outcome in a professional, marketing-friendly tone.`;
            
            try {
                const generatedText = await runGeminiRequest(prompt);
                briefArea.value = generatedText.trim();
                // OPTIMIZATION: Automatically save the brief change to prevent loss
                saveChangesToLocalStorage(false);
                alert('Brief successfully generated and updated.');

            } catch (error) {
                alert(`Failed to generate brief: ${error.message}`);
                console.error(error);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // --- NANO BANANA (IMAGEN) FUNCTIONS ---

        function openImagePrompt(fieldId) {
            currentImageFieldId = fieldId;
            document.getElementById('image-prompt-modal').classList.remove('hidden');
             // FIX: Validate API key before opening the modal
            if (!document.getElementById('geminiApiKey').value) {
                return alert("Please enter your Gemini API Key first.");
            }
            // FIX: Ensure project is selected for better default prompt
            const defaultPrompt = selectedProject 
                ? `A clean, professional UI mockup for a ${selectedProject.title} project, minimalist digital art style, high resolution.`
                : 'Minimalist product design mockup, clean lines, high resolution.';

            document.getElementById('image-prompt-input').value = defaultPrompt;
        }

        function closeImagePrompt() {
            document.getElementById('image-prompt-modal').classList.add('hidden');
            currentImageFieldId = null;
            document.getElementById('image-generation-status').classList.add('hidden');
        }

        async function runImageGenerationRequest(prompt, maxRetries = 5) {
            const apiKey = document.getElementById('geminiApiKey').value;
            if (!apiKey) {
                throw new Error("API Key is missing. Please enter your Gemini API Key.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_GENERATION_MODEL}:predict?key=${apiKey}`;

            const payload = { 
                instances: [{ prompt: prompt }], 
                parameters: { "sampleCount": 1 } 
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded, retrying in ${Math.round(delay / 1000)}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Image API request failed: ${response.status} - ${errorData.error?.message || response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        // Return data URL as the "image URL"
                        return `data:image/png;base64,${base64Data}`; 
                    }
                    throw new Error("Received empty or invalid image response from API.");

                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                }
            }
        }

        async function startImageGeneration() {
            const promptInput = document.getElementById('image-prompt-input');
            const btn = document.getElementById('start-image-generation-btn');
            const statusDiv = document.getElementById('image-generation-status');
            const originalText = btn.textContent;

            const prompt = promptInput.value.trim();
            if (!prompt) return alert("Please enter a description for the image.");
            
            btn.disabled = true;
            btn.textContent = 'Working...';
            statusDiv.classList.remove('hidden');

            try {
                const imageUrl = await runImageGenerationRequest(prompt);
                
                const targetInput = document.getElementById(currentImageFieldId);
                targetInput.value = imageUrl;
                
                // Update the preview based on the target field
                if (currentImageFieldId === 'heroImage') {
                    updateImagePreview(currentImageFieldId, imageUrl);
                } else if (currentImageFieldId.startsWith('mediaInput-')) {
                    const parts = currentImageFieldId.split('-');
                    const isVideoId = `isVideo-${parts[1]}-${parts[2]}`;
                    updateSectionMediaPreview(currentImageFieldId, isVideoId);
                }
                
                // OPTIMIZATION: Immediately save the change
                saveChangesToLocalStorage(false);

                closeImagePrompt();
                alert('Image successfully generated and inserted into the URL field.');

            } catch (error) {
                alert(`Failed to generate image: ${error.message}`);
                console.error(error);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
                statusDiv.classList.add('hidden');
            }
        }


        // --- Standard UI and Persistence Functions ---

        function renderProjectList() {
            const listDiv = document.getElementById('project-list');
            const quickSelect = document.getElementById('quick-select-project');
            listDiv.innerHTML = '';
            quickSelect.innerHTML = '<option value="">-- Select Project --</option>';

            const header = document.createElement('h2');
            header.className = 'text-2xl font-bold mb-4';
            header.textContent = 'Select Project to Edit (or create a new one):';
            listDiv.appendChild(header);

            currentProjects.forEach((project, index) => {
                const container = document.createElement('div');
                container.className = 'flex items-center space-x-3 mb-2';

                // Reorder Controls (Up/Down)
                const upButton = document.createElement('button');
                upButton.type = 'button';
                upButton.className = 'text-gray-500 hover:text-indigo-600 p-1 rounded disabled:opacity-30 disabled:cursor-not-allowed';
                upButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>'; 
                upButton.title = 'Move Up';
                upButton.disabled = index === 0;
                upButton.onclick = (e) => { e.stopPropagation(); reorderProject(project.id, -1); };

                const downButton = document.createElement('button');
                downButton.type = 'button';
                downButton.className = 'text-gray-500 hover:text-indigo-600 p-1 rounded disabled:opacity-30 disabled:cursor-not-allowed';
                downButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>'; 
                downButton.title = 'Move Down';
                downButton.disabled = index === currentProjects.length - 1;
                downButton.onclick = (e) => { e.stopPropagation(); reorderProject(project.id, 1); };
                
                // Duplicate Button
                const duplicateButton = document.createElement('button');
                duplicateButton.type = 'button';
                duplicateButton.className = 'text-gray-500 hover:text-orange-600 p-1 rounded';
                duplicateButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7v4m0 0v4m0-4h4m-4 0H4m8 8h.01M12 11h.01M12 7h.01M16 11h.01M16 7h.01M16 15h.01M16 19h.01M16 19v-4m0 4l4-4M16 19l-4-4"/></svg>';
                duplicateButton.title = 'Duplicate Project';
                duplicateButton.onclick = (e) => { e.stopPropagation(); duplicateProject(project.id); };


                // Project Button (Clickable area to edit)
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'text-gray-500 hover:text-red-600 p-1 rounded';
                deleteButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
                deleteButton.title = 'Delete Project';
                deleteButton.onclick = (e) => { e.stopPropagation(); deleteProject(project.id); };
                
                const editButton = document.createElement('button');
                const isHiddenClass = project.isHidden ? 'border-red-500 bg-red-100 text-red-700' : 'border-gray-300 text-gray-700 bg-white';
                
                let selectedClass = '';
                if (selectedProject && selectedProject.id === project.id) {
                    selectedClass = ' project-selected';
                }

                editButton.className = `inline-flex items-center px-4 py-2 border text-sm font-medium rounded-md shadow-sm hover:bg-gray-50 flex-grow ${isHiddenClass}${selectedClass}`;
                editButton.textContent = `${index + 1}. ${project.title} ${project.isHidden ? ' (DRAFT)' : ''}`;
                editButton.onclick = () => selectProject(project.id);
                
                container.appendChild(upButton);
                container.appendChild(downButton);
                container.appendChild(duplicateButton);
                container.appendChild(editButton);
                container.appendChild(deleteButton); // Add delete button
                listDiv.appendChild(container);
                
                // Populate Quick Access Selector
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${index + 1}. ${project.title}`;
                quickSelect.appendChild(option);
            });
            
            // Ensure the selection state is correct in the dropdown after render
            if (selectedProject) {
                quickSelect.value = selectedProject.id;
            } else {
                quickSelect.value = "";
            }
        }
        
        function selectProject(projectId) {
            
            // CRITICAL FIX: Save any pending changes before switching
            if (selectedProject) {
                 saveChangesToLocalStorage(false);
            }

            selectedProject = currentProjects.find(p => p.id === projectId);
            
            document.getElementById('edit-title').textContent = selectedProject.title;
            const editingArea = document.getElementById('editing-area');
            editingArea.classList.remove('hidden');

            editingArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

            renderProjectList(); 

            // --- Populate General Info fields ---
            document.getElementById('id').value = selectedProject.id;
            document.getElementById('title').value = selectedProject.title;
            document.getElementById('year').value = selectedProject.year;
            document.getElementById('heroImage').value = selectedProject.heroImage;
            document.getElementById('isHidden').checked = selectedProject.isHidden || false;

            updateImagePreview('heroImage', selectedProject.heroImage);
            
            // --- Populate and Handle Category ---
            const select = document.getElementById('category-select');
            const customInput = document.getElementById('category-custom');
            select.innerHTML = '';
            
            // Add existing categories + a "Custom" option
            [...UNIQUE_CATEGORIES, '--- Custom/New Category ---'].forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });

            // Set the current category
            const currentCategory = selectedProject.category;
            if (UNIQUE_CATEGORIES.includes(currentCategory)) {
                select.value = currentCategory;
                customInput.value = '';
                customInput.classList.add('hidden');
            } else {
                select.value = '--- Custom/New Category ---';
                customInput.value = currentCategory;
                customInput.classList.remove('hidden');
            }

            // Listener to toggle custom input visibility
            select.onchange = (e) => {
                if (e.target.value === '--- Custom/New Category ---') {
                    customInput.classList.remove('hidden');
                    customInput.value = '';
                } else {
                    customInput.classList.add('hidden');
                }
            };
            
            // --- Populate and Handle Accent Color ---
            renderColorPicker(selectedProject.accentColor || TAILWIND_COLORS_MAP[0].class);
            updateAccentColorPreview();

            // --- Populate Modal Intro & Details ---
            document.getElementById('brief').value = selectedProject.caseStudy.brief;

            const clientVal = selectedProject.caseStudy.client || '';
            const roleVal = selectedProject.caseStudy.role || '';
            const durationVal = selectedProject.caseStudy.duration || '';

            document.getElementById('client').value = clientVal;
            document.getElementById('role').value = roleVal;
            document.getElementById('duration').value = durationVal;

            // Handle Checkboxes (enable/disable inputs)
            document.getElementById('enableClient').checked = !!clientVal;
            document.getElementById('client').disabled = !document.getElementById('enableClient').checked;
            document.getElementById('enableClient').onchange = (e) => document.getElementById('client').disabled = !e.target.checked;
            
            document.getElementById('enableRole').checked = !!roleVal;
            document.getElementById('role').disabled = !document.getElementById('enableRole').checked;
            document.getElementById('enableRole').onchange = (e) => document.getElementById('role').disabled = !e.target.checked;
            
            document.getElementById('enableDuration').checked = !!durationVal;
            document.getElementById('duration').disabled = !document.getElementById('enableDuration').checked;
            document.getElementById('enableDuration').onchange = (e) => document.getElementById('duration').disabled = !e.target.checked;

            // Render dynamic sections UI
            renderSections();
        }

        function createNewProject() {
            const newId = `project-${crypto.randomUUID()}`;
            const newProject = {
                id: newId, 
                title: 'NEW PROJECT TITLE', 
                category: UNIQUE_CATEGORIES[0] || 'New Category',
                year: (new Date()).getFullYear().toString(),
                heroImage: 'https://placehold.co/800x600/cccccc/333333?text=New+Project', 
                accentColor: TAILWIND_COLORS_MAP[0].class, 
                isHidden: true,
                caseStudy: {
                    client: '', 
                    role: '', 
                    duration: '',
                    brief: 'This is a new project waiting for your custom brief. Check the "Hide Project" box to make it visible on the live site.',
                    sections: [
                        { 
                            id: 'new-section-1', 
                            title: '01. Getting Started', 
                            content: 'Describe the challenge here.',
                            mediaItems: []
                        }
                    ],
                }
            };
            currentProjects.push(newProject);
            collectUniqueCategories(); 
            // CRITICAL: Save to local storage after creation
            localStorage.setItem('portfolioProjects', JSON.stringify(currentProjects));
            renderProjectList();
            updateJSOutput();
            selectProject(newId);
        }
        
        function duplicateProject(projectId) {
            // CRITICAL: Save any pending changes before duplicating
            saveChangesToLocalStorage(false);

            const originalProject = currentProjects.find(p => p.id === projectId);
            if (!originalProject) return;

            const duplicatedProject = JSON.parse(JSON.stringify(originalProject));
            
            const newId = `project-${crypto.randomUUID()}`;
            duplicatedProject.id = newId;
            duplicatedProject.title = `${originalProject.title} (COPY)`;
            duplicatedProject.isHidden = true;
            
            const originalIndex = currentProjects.findIndex(p => p.id === projectId);
            currentProjects.splice(originalIndex + 1, 0, duplicatedProject);

            collectUniqueCategories();
            localStorage.setItem('portfolioProjects', JSON.stringify(currentProjects));
            renderProjectList();
            updateJSOutput();
            selectProject(newId);
            alert(`Project "${duplicatedProject.title}" duplicated successfully. Now editing the copy (DRAFT).`);
        }

        function deleteProject(projectId) {
            if (confirm("Are you sure you want to permanently delete this project? This cannot be undone.")) {
                // CRITICAL: Save any pending changes before deleting
                saveChangesToLocalStorage(false);

                const indexToDelete = currentProjects.findIndex(p => p.id === projectId);
                if (indexToDelete === -1) return;

                currentProjects.splice(indexToDelete, 1);

                // If the deleted project was the selected one, unselect it and hide the form
                if (selectedProject && selectedProject.id === projectId) {
                    selectedProject = null;
                    document.getElementById('editing-area').classList.add('hidden');
                }

                collectUniqueCategories();
                localStorage.setItem('portfolioProjects', JSON.stringify(currentProjects));
                renderProjectList();
                updateJSOutput();
                alert('Project deleted successfully.');

                // Select the first project if others exist
                if (!selectedProject && currentProjects.length > 0) {
                    selectProject(currentProjects[0].id);
                }
            }
        }
        
        function handleSaveAndCopy() {
            saveChangesToLocalStorage();
            copyGeneratedCode();
        }

        function saveChangesToLocalStorage(showAlert = true) {
            if (!selectedProject) {
                 if (showAlert) alert('No project selected to save.');
                 return;
            }
            
            try {
                // 1. Update General Info fields
                selectedProject.title = document.getElementById('title').value;
                
                const select = document.getElementById('category-select');
                const customInput = document.getElementById('category-custom');
                let newCategory = select.value;
                if (newCategory === '--- Custom/New Category ---') {
                    newCategory = customInput.value || 'Uncategorized';
                }
                selectedProject.category = newCategory;

                selectedProject.year = document.getElementById('year').value;
                selectedProject.heroImage = document.getElementById('heroImage').value;
                selectedProject.accentColor = document.getElementById('accentColor-select').value; 
                selectedProject.isHidden = document.getElementById('isHidden').checked; 
                
                // 2. Update Modal Intro & Details
                selectedProject.caseStudy.brief = document.getElementById('brief').value;

                // Update Client/Role/Duration (only save if enabled)
                selectedProject.caseStudy.client = document.getElementById('enableClient').checked ? document.getElementById('client').value : '';
                selectedProject.caseStudy.role = document.getElementById('enableRole').checked ? document.getElementById('role').value : '';
                selectedProject.caseStudy.duration = document.getElementById('enableDuration').checked ? document.getElementById('duration').value : '';
                
                // 3. Rebuild sections from dynamic fields
                const sectionsContainer = document.getElementById('sections-container');
                const newSections = [];
                
                sectionsContainer.querySelectorAll('.section-card').forEach((card, index) => {
                    const titleInputEl = card.querySelector('.section-title-input');
                    const contentInputEl = card.querySelector('.section-content-input');
                    
                    if (!titleInputEl || !contentInputEl) {
                        console.warn(`Skipping section at index ${index} due to missing input elements.`);
                        return;
                    }

                    const titleInput = titleInputEl.value;
                    const contentInput = contentInputEl.value;
                    
                    // --- Read Media Items ---
                    const newMediaItems = [];
                    card.querySelectorAll('.media-item-container').forEach(mediaContainer => {
                        const urlInput = mediaContainer.querySelector('.media-item-url-input');
                        const isVideoCheckbox = mediaContainer.querySelector('.media-item-isvideo-checkbox');
                        
                        // CRITICAL FIX: Only save media item if it has a URL
                        if (urlInput && urlInput.value.trim()) {
                            newMediaItems.push({ 
                                url: urlInput.value, 
                                isVideo: isVideoCheckbox ? isVideoCheckbox.checked : false 
                            });
                        }
                    });


                    // Reconstruct section ID and title numbering
                    const titleSuffix = titleInput.replace(/^\d{2}\. /, '').trim();
                    const baseId = titleSuffix.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || `section-${index + 1}`;
                    const newTitle = `${String(index + 1).padStart(2, '0')}. ${titleSuffix}`; 

                    newSections.push({
                        id: baseId,
                        title: newTitle,
                        content: contentInput,
                        mediaItems: newMediaItems, 
                    });
                });
                selectedProject.caseStudy.sections = newSections;

                // 4. Save to localStorage and update output
                localStorage.setItem('portfolioProjects', JSON.stringify(currentProjects));
                collectUniqueCategories(); 
                renderProjectList(); 
                updateJSOutput(); 
                
                if (showAlert) {
                   alert('SUCCESS: Project data saved locally and JavaScript code updated below.');
                }
                
            } catch (error) {
                alert('ERROR: Could not save changes. Please check all fields for valid input.');
                console.error(error);
            }
        }
        
        function copyGeneratedCode() {
            copyToClipboard('js-output');
            alert('Generated JavaScript code has been copied to your clipboard. Replace the entire content of projects_data.js.');
        }

        // --- Dynamic Section Rendering ---

        function renderSections() {
             const container = document.getElementById('sections-container');
            container.innerHTML = '';
            
            if (!selectedProject || selectedProject.caseStudy.sections.length === 0) {
                 container.innerHTML = `
                    <div class="p-6 text-center border-2 border-dashed border-indigo-300 rounded-lg bg-indigo-50">
                        <p class="text-indigo-800 font-semibold mb-2">This project has no case study sections yet.</p>
                        <p class="text-sm text-indigo-600">Click the 'âž• Add New Section' button below to start building your case study!</p>
                    </div>
                `;
            } else {
                selectedProject.caseStudy.sections.forEach((section, index) => {
                    container.appendChild(buildSectionHTML(section, index));
                });
            }
            
            // Re-initialize previews for all rendered sections after they are in the DOM
            selectedProject.caseStudy.sections.forEach((section, sectionIndex) => {
                (section.mediaItems || []).forEach((item, itemIndex) => {
                    const urlInputId = `mediaInput-${sectionIndex}-${itemIndex}`;
                    const isVideoId = `isVideo-${sectionIndex}-${itemIndex}`;
                    
                    // We need to manually set the checkbox state, as innerHTML doesn't preserve it
                    setTimeout(() => {
                        const videoCheckbox = document.getElementById(isVideoId);
                        if (videoCheckbox) {
                             videoCheckbox.checked = item.isVideo;
                             updateSectionMediaPreview(urlInputId, isVideoId);
                        }
                    }, 0);
                });
            });
        }

        function buildSectionHTML(section, sectionIndex) {
            // CRITICAL FIX: Extract title without numbering for input field value
            const titleWithoutPrefix = section.title.replace(/^\d{2}\. /, '').trim();

             const card = document.createElement('div');
            card.className = 'section-card';
            card.setAttribute('data-index', sectionIndex);
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-3 border-b pb-2">
                    <h4 class="font-bold text-lg text-indigo-800">Section ${sectionIndex + 1}</h4>
                    <button type="button" onclick="removeSection(${sectionIndex})" class="text-sm font-medium text-red-600 hover:text-red-800">
                        Remove
                    </button>
                </div>
                
                <label class="block text-sm font-medium text-gray-700 mt-2">Section Title (e.g., 'The Problem & Goal')</label>
                <input type="text" value="${titleWithoutPrefix}" class="section-title-input mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Enter title without numbering">
                
                <label class="block text-sm font-medium text-gray-700 mt-4">Section Copy</label>
                <textarea rows="4" class="section-content-input mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">${section.content || ''}</textarea>
                
                <h5 class="font-bold text-sm text-gray-700 mt-4 mb-2">Media Items:</h5>
                <div id="media-items-container-${sectionIndex}" class="media-items-list space-y-3 p-3 border border-dashed border-gray-300 rounded-lg">
                    </div>
                
                <button type="button" onclick="addMediaItem(${sectionIndex})" class="mt-3 inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-white bg-indigo-500 hover:bg-indigo-600">
                    âž• Add Media Item
                </button>
            `;
            
            // Inject media items
            const mediaListContainer = card.querySelector(`#media-items-container-${sectionIndex}`);
            (section.mediaItems || []).forEach((item, itemIndex) => {
                const itemHtml = renderMediaItemHTML(sectionIndex, item, itemIndex);
                mediaListContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
            
            return card;
        }

        // Renders the HTML for a single media item field group
        function renderMediaItemHTML(sectionIndex, item, itemIndex) {
            const urlInputId = `mediaInput-${sectionIndex}-${itemIndex}`;
            const isVideoId = `isVideo-${sectionIndex}-${itemIndex}`;
            
            // NOTE: Checkbox status is NOT set in innerHTML but handled in renderSections 
            // via setTimeout to ensure dynamic event listeners and state are correct.

            return `
                <div class="media-item-container p-3 border border-gray-200 rounded-md bg-white shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="text-sm font-bold text-gray-800">Media Item ${itemIndex + 1}</h5>
                        <button type="button" onclick="removeMediaItem(${sectionIndex}, ${itemIndex})" class="text-red-500 hover:text-red-700 text-xs">
                            Remove Item
                        </button>
                    </div>

                    <label class="block text-xs font-medium text-gray-700 mt-2">Media URL (Image or Video)</label>
                    <div class="flex space-x-2 mt-1">
                        <input type="url" id="${urlInputId}" value="${item.url || ''}" 
                               class="media-item-url-input block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm" 
                               placeholder="Paste URL here" 
                               oninput="updateSectionMediaPreview('${urlInputId}', '${isVideoId}')">
                        <button type="button" onclick="openImagePrompt('${urlInputId}')" 
                                class="flex-shrink-0 px-3 py-1 bg-pink-600 text-white text-xs font-medium rounded-md hover:bg-pink-700 disabled:bg-gray-400">
                            ðŸŽ¨ AI
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-2 mt-2">
                        <input type="checkbox" id="${isVideoId}"
                               class="media-item-isvideo-checkbox rounded text-indigo-600 focus:ring-indigo-500" 
                               onchange="updateSectionMediaPreview('${urlInputId}', '${isVideoId}')">
                        <label for="${isVideoId}" class="text-xs text-gray-700">Treat as Video (YouTube/Vimeo or direct file)</label>
                    </div>

                    <div id="${urlInputId}-preview-container" class="mt-2">
                        <div id="${urlInputId}-preview" class="preview-container border border-gray-300 rounded-md bg-gray-200 overflow-hidden"></div>
                    </div>
                </div>
            `;
        }
        
        function addMediaItem(sectionIndex) {
            if (!selectedProject || !selectedProject.caseStudy.sections[sectionIndex]) return;
            
            // CRITICAL FIX: Always save form state before array mutation
            saveChangesToLocalStorage(false); 
            
            const section = selectedProject.caseStudy.sections[sectionIndex];
            if (!section.mediaItems) {
                section.mediaItems = [];
            }
            section.mediaItems.push({
                url: '',
                isVideo: false
            });
            
            localStorage.setItem('portfolioProjects', JSON.stringify(currentProjects));
            updateJSOutput(); 
            // Render from the newly updated currentProjects model
            renderSections();
        }

        function removeMediaItem(sectionIndex, itemIndex) {
            if (!selectedProject || !selectedProject.caseStudy.sections[sectionIndex]) return;

            if (confirm(`Are you sure you want to remove Media Item ${itemIndex + 1}?`)) {
                
                // CRITICAL FIX: Always save form state before array mutation
                saveChangesToLocalStorage(false); 
                
                const section = selectedProject.caseStudy.sections[sectionIndex];
                section.mediaItems.splice(itemIndex, 1);
                
                localStorage.setItem('portfolioProjects', JSON.stringify(currentProjects));
                updateJSOutput();
                
                // Render from the newly updated currentProjects model
                renderSections();
            }
        }

        function addSectionField() {
            if (!selectedProject) return;
            
            // CRITICAL FIX: Always save form state before array mutation
            saveChangesToLocalStorage(false);
            
            const sections = selectedProject.caseStudy.sections;
            const newIndex = sections.length;
            const newSection = {
                id: `new-section-${newIndex + 1}`,
                title: `${String(newIndex + 1).padStart(2, '0')}. NEW SECTION`,
                content: 'Add new content here.',
                mediaItems: [] 
            };
            sections.push(newSection);

            localStorage.setItem('portfolioProjects', JSON.stringify(currentProjects));
            updateJSOutput(); 
            
            // Render from the newly updated currentProjects model
            renderSections();
        }

        function removeSection(indexToRemove) {
            if (!selectedProject || !selectedProject.caseStudy.sections[indexToRemove]) return;

            const sectionTitle = selectedProject.caseStudy.sections[indexToRemove].title;
            if (confirm(`Are you sure you want to remove Section ${indexToRemove + 1}: ${sectionTitle}?`)) {
                
                // CRITICAL FIX: Always save form state before array mutation
                saveChangesToLocalStorage(false);
                
                selectedProject.caseStudy.sections.splice(indexToRemove, 1);
                
                // CRITICAL FIX: Renumber remaining sections after deletion
                selectedProject.caseStudy.sections.forEach((s, i) => {
                    const newTitlePrefix = String(i + 1).padStart(2, '0') + ". ";
                    // Ensure we only replace the number prefix, not the actual content
                    const oldTitleSuffix = s.title.replace(/^\d{2}\. /, '').trim();
                    s.title = newTitlePrefix + oldTitleSuffix;
                    // Also update the ID based on the (renumbered) title suffix
                    s.id = oldTitleSuffix.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || `section-${i + 1}`;
                });
                
                localStorage.setItem('portfolioProjects', JSON.stringify(currentProjects));
                updateJSOutput();
                
                // Render from the newly updated currentProjects model
                renderSections();
            }
        }

        // --- Output Generation and Copy ---

        function updateJSOutput() {
            // 1. Generate the raw array string using standard JSON.stringify (produces double quotes)
            let rawArrayString = JSON.stringify(currentProjects, null, 4);

            // 2. Define the keys that can have their quotes removed (property names)
            const keysToUnquote = ['id', 'title', 'category', 'year', 'heroImage', 'accentColor', 'isHidden', 'caseStudy', 'client', 'role', 'duration', 'brief', 'sections', 'content', 'mediaItems', 'url', 'isVideo']; 
            
            // 3. Remove double quotes around OBJECT KEYS ONLY (preserving quotes around string values)
            keysToUnquote.forEach(key => {
                const regex = new RegExp(`"${key}":`, 'g');
                rawArrayString = rawArrayString.replace(regex, `${key}:`);
            });
            
            // 4. Wrap the array string with the necessary declaration for full file replacement
            const finalOutput = `const ALL_PROJECTS = ${rawArrayString};`;
            
            // Set the textarea value to the complete file content
            document.getElementById('js-output').value = finalOutput;
        }
        
        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            // Use modern clipboard API if available, fallback to execCommand
            if (navigator.clipboard) {
                navigator.clipboard.writeText(copyText.value).then(() => {
                    // Success is handled by the caller (handleSaveAndCopy)
                }).catch(err => {
                    console.error('Modern copy failed', err);
                    document.execCommand('copy');
                });
            } else {
                 document.execCommand('copy');
            }
        }
        
        // --- Reorder Function ---
        function reorderProject(projectId, direction) {
            const index = currentProjects.findIndex(p => p.id === projectId);
            if (index === -1) return;

            // CRITICAL FIX: Save form state before manipulation
            saveChangesToLocalStorage(false);

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentProjects.length) return;

            // Swap elements in the array
            const [project] = currentProjects.splice(index, 1);
            currentProjects.splice(newIndex, 0, project);

            // Update local storage and output
            localStorage.setItem('portfolioProjects', JSON.stringify(currentProjects));
            updateJSOutput();
            
            // Re-render list and re-select
            renderProjectList();
            if (selectedProject && selectedProject.id === projectId) {
                // No need to call selectProject, just ensure the list is rendered correctly
            }
        }


        // Initialize on load
        window.onload = initializeApp;
    </script>
</body>
</html>